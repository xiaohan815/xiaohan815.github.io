<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hooks | xh的博客</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="A REST and real-time API layer for modern applications">
    
    <link rel="preload" href="/assets/css/0.styles.71eccbd5.css" as="style"><link rel="preload" href="/assets/js/app.f4b1d533.js" as="script"><link rel="preload" href="/assets/js/3.7ef197bc.js" as="script"><link rel="preload" href="/assets/js/6.bfb1454e.js" as="script"><link rel="prefetch" href="/assets/js/10.75479bb3.js"><link rel="prefetch" href="/assets/js/11.06dc4d05.js"><link rel="prefetch" href="/assets/js/12.b400be4b.js"><link rel="prefetch" href="/assets/js/13.468db7cc.js"><link rel="prefetch" href="/assets/js/14.c0fd1ba2.js"><link rel="prefetch" href="/assets/js/15.decd1b48.js"><link rel="prefetch" href="/assets/js/16.5dd5709b.js"><link rel="prefetch" href="/assets/js/17.d4f6d12f.js"><link rel="prefetch" href="/assets/js/18.fe8ad097.js"><link rel="prefetch" href="/assets/js/19.937b245a.js"><link rel="prefetch" href="/assets/js/20.7cc52ec4.js"><link rel="prefetch" href="/assets/js/21.05c5bcbb.js"><link rel="prefetch" href="/assets/js/22.c617dc8b.js"><link rel="prefetch" href="/assets/js/23.4e0a4ba3.js"><link rel="prefetch" href="/assets/js/24.3ddb4d5e.js"><link rel="prefetch" href="/assets/js/25.ce1df76d.js"><link rel="prefetch" href="/assets/js/26.c258552f.js"><link rel="prefetch" href="/assets/js/27.bf72b2a4.js"><link rel="prefetch" href="/assets/js/28.f36eb311.js"><link rel="prefetch" href="/assets/js/29.a8389ebb.js"><link rel="prefetch" href="/assets/js/30.1bb11e5b.js"><link rel="prefetch" href="/assets/js/31.420db076.js"><link rel="prefetch" href="/assets/js/32.227f3c52.js"><link rel="prefetch" href="/assets/js/33.74f30a07.js"><link rel="prefetch" href="/assets/js/34.6800baab.js"><link rel="prefetch" href="/assets/js/35.1364295d.js"><link rel="prefetch" href="/assets/js/36.1f3555c4.js"><link rel="prefetch" href="/assets/js/37.03460d49.js"><link rel="prefetch" href="/assets/js/38.7288c585.js"><link rel="prefetch" href="/assets/js/39.be2cc39a.js"><link rel="prefetch" href="/assets/js/4.69d337f5.js"><link rel="prefetch" href="/assets/js/40.25a2c3c6.js"><link rel="prefetch" href="/assets/js/41.00f9dadf.js"><link rel="prefetch" href="/assets/js/42.5befdd01.js"><link rel="prefetch" href="/assets/js/43.35a181f3.js"><link rel="prefetch" href="/assets/js/44.40ab2e80.js"><link rel="prefetch" href="/assets/js/45.ef5a1522.js"><link rel="prefetch" href="/assets/js/46.933ea0fe.js"><link rel="prefetch" href="/assets/js/47.bdc1d06e.js"><link rel="prefetch" href="/assets/js/48.2a8183d7.js"><link rel="prefetch" href="/assets/js/49.df5b3519.js"><link rel="prefetch" href="/assets/js/5.819c231b.js"><link rel="prefetch" href="/assets/js/50.f6e77e4d.js"><link rel="prefetch" href="/assets/js/51.52640232.js"><link rel="prefetch" href="/assets/js/52.887b891d.js"><link rel="prefetch" href="/assets/js/53.0a327f41.js"><link rel="prefetch" href="/assets/js/54.5855f8f3.js"><link rel="prefetch" href="/assets/js/55.376b3041.js"><link rel="prefetch" href="/assets/js/56.8d2aae84.js"><link rel="prefetch" href="/assets/js/57.945b40cd.js"><link rel="prefetch" href="/assets/js/58.fce6fb60.js"><link rel="prefetch" href="/assets/js/59.efb6444b.js"><link rel="prefetch" href="/assets/js/60.721cd48d.js"><link rel="prefetch" href="/assets/js/61.356f751f.js"><link rel="prefetch" href="/assets/js/62.9538717e.js"><link rel="prefetch" href="/assets/js/7.3aae742d.js"><link rel="prefetch" href="/assets/js/8.41a4751c.js"><link rel="prefetch" href="/assets/js/9.45376988.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e84523f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.71eccbd5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/feathers-logo-wide.png" alt="xh的博客" class="logo"></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guides/" class="nav-link router-link-active">Guides</a></div><div class="nav-item"><a href="/api/" class="nav-link">API</a></div><div class="nav-item"><a href="/cookbook/" class="nav-link">Cookbook</a></div><div class="nav-item"><a href="/help/" class="nav-link">Help</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Ecosystem</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/feathersjs/awesome-feathersjs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Awesome Feathersjs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.youtube.com/playlist?list=PLwSdIiqnDlf_lb5y1liQK2OW5daXYgKOe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  YouTube Playlist
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuex.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Feathers VueX
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://hooks-common.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Common Hooks
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><h4>Other versions</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://dove.docs.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Dove (v5, next)
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://buzzard.docs.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Buzzard (v3)
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://auk.docs.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Auk (v2)
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/feathersjs/feathers" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guides/" class="nav-link router-link-active">Guides</a></div><div class="nav-item"><a href="/api/" class="nav-link">API</a></div><div class="nav-item"><a href="/cookbook/" class="nav-link">Cookbook</a></div><div class="nav-item"><a href="/help/" class="nav-link">Help</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Ecosystem</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/feathersjs/awesome-feathersjs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Awesome Feathersjs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.youtube.com/playlist?list=PLwSdIiqnDlf_lb5y1liQK2OW5daXYgKOe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  YouTube Playlist
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuex.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Feathers VueX
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://hooks-common.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Common Hooks
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><h4>Other versions</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://dove.docs.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Dove (v5, next)
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://buzzard.docs.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Buzzard (v3)
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://auk.docs.feathersjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Auk (v2)
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/feathersjs/feathers" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>The Feathers guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guides/basics/setup.html" class="sidebar-link">Getting ready</a></li><li><a href="/guides/basics/starting.html" class="sidebar-link">Quick start</a></li><li><a href="/guides/basics/generator.html" class="sidebar-link">Generating an app</a></li><li><a href="/guides/basics/services.html" class="sidebar-link">Services</a></li><li><a href="/guides/basics/hooks.html" aria-current="page" class="active sidebar-link">Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#quick-example" class="sidebar-link">Quick example</a></li><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#hook-functions" class="sidebar-link">Hook functions</a></li><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#hook-context" class="sidebar-link">Hook context</a></li><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#registering-hooks" class="sidebar-link">Registering hooks</a></li><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#processing-messages" class="sidebar-link">Processing messages</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#sanitize-new-message" class="sidebar-link">Sanitize new message</a></li><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#populate-the-message-sender" class="sidebar-link">Populate the message sender</a></li></ul></li><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#hooks-vs-extending-services" class="sidebar-link">Hooks vs. extending services</a></li><li class="sidebar-sub-header"><a href="/guides/basics/hooks.html#what-s-next" class="sidebar-link">What's next?</a></li></ul></li><li><a href="/guides/basics/authentication.html" class="sidebar-link">Authentication</a></li><li><a href="/guides/basics/frontend.html" class="sidebar-link">Building a frontend</a></li><li><a href="/guides/basics/testing.html" class="sidebar-link">Writing tests</a></li></ul></section></li><li><a href="/guides/frameworks.html" class="sidebar-link">Frontend Frameworks</a></li><li><a href="/guides/security.html" class="sidebar-link">Security</a></li><li><a href="/guides/migrating.html" class="sidebar-link">Migrating</a></li></ul> </aside> <main class="page"> <div class="content content__default"><h1 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h1> <p>As we have seen in the <a href="/guides/basics/services.html">services chapter</a>, Feathers services are a great way to implement data storage and modification. Technically, we could implement our entire app with services but very often we need similar functionality across multiple services. For example, we might want to check for all services if a user is allowed to even use it or add the current date to all data that we are saving. With just using services we would have to implement this again every time.</p> <p>This is where Feathers hooks come in. Hooks are pluggable middleware functions that can be registered <strong>before</strong>, <strong>after</strong> or on <strong>errors</strong> of a service method. You can register a single hook function or create a chain of them to create complex work-flows. In this chapter we will learn more about hooks and create workflows to process new chat messages.</p> <p>Just like services themselves, hooks are <em>transport independent</em>. They are usually also service agnostic, meaning they can be used with ​<em>any</em>​ service. This pattern keeps your application logic flexible, composable, and much easier to trace through and debug.</p> <blockquote><p><strong>Note:</strong> A full overview of the hook API can be found in the <a href="/api/hooks.html">hooks API documentation</a>.</p></blockquote> <p>Hooks are commonly used to handle things like validation, authorization, logging, populating related entities, sending notifications and more.</p> <blockquote><p><strong>Pro tip:</strong> For the general design pattern behind hooks see <a href="https://blog.feathersjs.com/design-patterns-for-modern-web-apis-1f046635215" target="_blank" rel="noopener noreferrer">this blog post<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. A more Feathers specific overview can be found <a href="https://blog.feathersjs.com/api-service-composition-with-hooks-47af13aa6c01" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></blockquote> <h2 id="quick-example"><a href="#quick-example" class="header-anchor">#</a> Quick example</h2> <p>Here is a quick example for a hook that adds a <code>createdAt</code> property to the data before calling the actual <code>create</code> service method:</p> <div class="tabs-component"><ul role="tablist" class="tabs-component-tabs"></ul> <div class="tabs-component-panels"><section aria-hidden="true" id="javascript" role="tabpanel" class="tabs-component-panel" style="display:none;"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createdAt</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>data<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string">'messages'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  before<span class="token operator">:</span> <span class="token punctuation">{</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span> createdAt <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section> <section aria-hidden="true" id="typescript" role="tabpanel" class="tabs-component-panel" style="display:none;"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HookContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@feathersjs/feathers'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createdAt</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token operator">:</span> HookContext<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>data<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string">'messages'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  before<span class="token operator">:</span> <span class="token punctuation">{</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span> createdAt <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section></div></div> <h2 id="hook-functions"><a href="#hook-functions" class="header-anchor">#</a> Hook functions</h2> <p>A hook function is a function that takes the <a href="#hook-context">hook context</a> as the parameter and returns that context or nothing. Hook functions run in the order they are registered and will only continue to the next once the current hook function completes. If a hook function throws an error, all remaining hooks (and the service call if it didn't run yet) will be skipped and the error will be returned.</p> <p>A common pattern the generator uses to make hooks more re-usable (e.g. making the <code>createdAt</code> property name from the example above configurable) is to create a wrapper function that takes those options and returns a hook function:</p> <div class="tabs-component"><ul role="tablist" class="tabs-component-tabs"></ul> <div class="tabs-component-panels"><section aria-hidden="true" id="javascript" role="tabpanel" class="tabs-component-panel" style="display:none;"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">setTimestamp</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>data<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 

app<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string">'messages'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  before<span class="token operator">:</span> <span class="token punctuation">{</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token string">'createdAt'</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token string">'updatedAt'</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section> <section aria-hidden="true" id="typescript" role="tabpanel" class="tabs-component-panel" style="display:none;"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HookContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@feathersjs/feathers'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">setTimestamp</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token operator">:</span> HookContext<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>data<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 

app<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string">'messages'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  before<span class="token operator">:</span> <span class="token punctuation">{</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token string">'createdAt'</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token string">'updatedAt'</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></section></div></div> <p>Now we have a re-usable hook that can set the timestamp on any property.</p> <h2 id="hook-context"><a href="#hook-context" class="header-anchor">#</a> Hook context</h2> <p>The hook <code>context</code> is an object which contains information about the service method call. It has read-only and writable properties.</p> <p>Read-only properties are:</p> <ul><li><code>context.app</code> - The Feathers application object. This can be used to e.g. call other services</li> <li><code>context.service</code> - The service this hook is currently running on</li> <li><code>context.path</code> - The path (name) of the service</li> <li><code>context.method</code> - The service method name</li> <li><code>context.type</code> - The hook type (<code>before</code>, <code>after</code> or <code>error</code>)</li></ul> <p>Writeable properties are:</p> <ul><li><code>context.params</code> - The service method call <code>params</code>. For external calls, <code>params</code> usually contains:
<ul><li><code>context.params.query</code> - The query (e.g. query string for REST) for the service call</li> <li><code>context.params.provider</code> - The name of the transport (which we will look at in the next chapter) the call has been made through. Usually <code>rest</code>, <code>socketio</code>, <code>primus</code>. Will be <code>undefined</code> for internal calls.</li></ul></li> <li><code>context.id</code> - The <code>id</code> for a <code>get</code>, <code>remove</code>, <code>update</code> and <code>patch</code> service method call</li> <li><code>context.data</code> - The <code>data</code> sent by the user in a <code>create</code>, <code>update</code> and <code>patch</code> service method call</li> <li><code>context.error</code> - The error that was thrown (in <code>error</code> hooks)</li> <li><code>context.result</code> - The result of the service method call (in <code>after</code> hooks)</li></ul> <blockquote><p><strong>Note:</strong> For more information about the hook context see the <a href="/api/hooks.html">hooks API documentation</a>.</p></blockquote> <h2 id="registering-hooks"><a href="#registering-hooks" class="header-anchor">#</a> Registering hooks</h2> <p>In a Feathers application generated by the CLI, hooks are being registered in a <code>.hooks</code> file in an object in the following format:</p> <div class="tabs-component"><ul role="tablist" class="tabs-component-tabs"></ul> <div class="tabs-component-panels"><section aria-hidden="true" id="javascript" role="tabpanel" class="tabs-component-panel" style="display:none;"><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  before<span class="token operator">:</span> <span class="token punctuation">{</span>
    all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    find<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    get<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    patch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  after<span class="token operator">:</span> <span class="token punctuation">{</span>
    all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    find<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    get<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    patch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  error<span class="token operator">:</span> <span class="token punctuation">{</span>
    all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    find<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    get<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    patch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></section> <section aria-hidden="true" id="typescript" role="tabpanel" class="tabs-component-panel" style="display:none;"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  before<span class="token operator">:</span> <span class="token punctuation">{</span>
    all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    find<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    patch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  after<span class="token operator">:</span> <span class="token punctuation">{</span>
    all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    find<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    patch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  error<span class="token operator">:</span> <span class="token punctuation">{</span>
    all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    find<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    patch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></section></div></div> <p>This makes it easy to see at one glance in which order hooks are executed and for which method.</p> <blockquote><p><strong>Note:</strong> <code>all</code> is a special keyword which means those hooks will run before the method specific hooks in this chain.</p></blockquote> <h2 id="processing-messages"><a href="#processing-messages" class="header-anchor">#</a> Processing messages</h2> <p>Cool. Now that we learned about hooks we can add two hooks to our messages service that help sanitize new messages and add information about the user that sent it.</p> <h3 id="sanitize-new-message"><a href="#sanitize-new-message" class="header-anchor">#</a> Sanitize new message</h3> <p>When creating a new message, we automatically sanitize our input, add the user that sent it and include the date the message has been created before saving it in the database. In this specific case it is a <em>before</em> hook. To create a new hook we can run:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>feathers generate hook
</code></pre></div><p>Let's call this hook <code>process-message</code>. We want to pre-process client-provided data. Therefore, in the next prompt asking for what kind of hook, choose <code>before</code> and press Enter.</p> <p>Next a list of all our services is displayed. For this hook, only choose the <code>messages</code> service. Navigate to the entry with the arrow keys and select it with the space key, then confirm with enter.</p> <p>A hook can run before any number of <a href="/guides/basics/services.html">service methods</a>. For this specific hook, only select <code>create</code>. After confirming the last prompt you should see something like this:</p> <p><img src="/assets/img/process-message-prompts.5fb49e9f.png" alt="feathers generate hook prompts"></p> <p>A hook was generated and wired up to the selected service. Now it's time to add some code.</p> <div class="tabs-component"><ul role="tablist" class="tabs-component-tabs"></ul> <div class="tabs-component-panels"><section aria-hidden="true" id="javascript" role="tabpanel" class="tabs-component-panel" style="display:none;"><p>Update <code>src/hooks/process-message.js</code> to look like this:</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// eslint-disable-line no-unused-vars</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>

    <span class="token comment">// Throw an error if we didn't get a text</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'A message must have a text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The logged in user</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token comment">// The actual message text</span>
    <span class="token comment">// Make sure that messages are no longer than 400 characters</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> data<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the original data (so that people can't submit additional stuff)</span>
    context<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span>
      text<span class="token punctuation">,</span>
      <span class="token comment">// Set the user id</span>
      userId<span class="token operator">:</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
      <span class="token comment">// Add the current date</span>
      createdAt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></section> <section aria-hidden="true" id="typescript" role="tabpanel" class="tabs-component-panel" style="display:none;"><p>Update <code>src/hooks/process-message.ts</code> to look like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Use this hook to manipulate incoming or outgoing data.</span>
<span class="token comment">// For more information on hooks see: http://docs.feathersjs.com/api/hooks.html</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Hook<span class="token punctuation">,</span> HookContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@feathersjs/feathers'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token parameter">Hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> HookContext</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>

    <span class="token comment">// Throw an error if we didn't get a text</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'A message must have a text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The authenticated user</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> context<span class="token punctuation">.</span>params<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
    <span class="token comment">// The actual message text</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> data<span class="token punctuation">.</span>text
      <span class="token comment">// Messages can't be longer than 400 characters</span>
      <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Override the original data (so that people can't submit additional stuff)</span>
    context<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span>
      text<span class="token punctuation">,</span>
      <span class="token comment">// Set the user id</span>
      userId<span class="token operator">:</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
      <span class="token comment">// Add the current date</span>
      createdAt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Best practice: hooks should always return the context</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></section></div></div> <p>This validation code includes:</p> <ol><li>A check if there is a <code>text</code> in the data and throws an error if not</li> <li>Truncate the message's <code>text</code> property to 400 characters</li> <li>Update the data submitted to the database to contain:
<ul><li>The new truncated text</li> <li>The currently authenticated user id (so we always know who sent it)</li> <li>The current (creation) date</li></ul></li></ol> <h3 id="populate-the-message-sender"><a href="#populate-the-message-sender" class="header-anchor">#</a> Populate the message sender</h3> <p>In the <code>process-message</code> hook we are currently just adding the user's <code>_id</code> as the <code>userId</code> property in the message. We want to show more information about the user that sent it in the UI, so we'll need to populate more data in the message response.</p> <p>We can do this by creating another hook called <code>populate-user</code> which is an <code>after</code> hook on the <code>messages</code> service for <code>all</code> methods:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>feathers generate hook
</code></pre></div><p><img src="/assets/img/populate-user-prompts.8b4bae9d.png" alt="feathers generate hook prompts"></p> <div class="tabs-component"><ul role="tablist" class="tabs-component-tabs"></ul> <div class="tabs-component-panels"><section aria-hidden="true" id="javascript" role="tabpanel" class="tabs-component-panel" style="display:none;"><p>Update <code>src/hooks/populate-user.js</code> to:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* eslint-disable require-atomic-updates */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// eslint-disable-line no-unused-vars</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get `app`, `method`, `params` and `result` from the hook context</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> method<span class="token punctuation">,</span> result<span class="token punctuation">,</span> params <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">// Function that adds the user to a single message object</span>
    <span class="token keyword">const</span> <span class="token function-variable function">addUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the user based on their id, pass the `params` along so</span>
      <span class="token comment">// that we get a safe version of the user data</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Merge the message content to include the `user` object</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>message<span class="token punctuation">,</span>
        user
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// In a find method we need to process the entire page</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'find'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Map all data to include the `user` information</span>
      context<span class="token punctuation">.</span>result<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>addUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Otherwise just update the single result</span>
      context<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addUser</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></section> <section aria-hidden="true" id="typescript" role="tabpanel" class="tabs-component-panel" style="display:none;"><p>Update <code>src/hooks/populate-user.ts</code> to:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Use this hook to manipulate incoming or outgoing data.</span>
<span class="token comment">// For more information on hooks see: http://docs.feathersjs.com/api/hooks.html</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Hook<span class="token punctuation">,</span> HookContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@feathersjs/feathers'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token operator">:</span> HookContext<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get `app`, `method`, `params` and `result` from the hook context</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> method<span class="token punctuation">,</span> result<span class="token punctuation">,</span> params <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">// Function that adds the user to a single message object</span>
    <span class="token keyword">const</span> <span class="token function-variable function">addUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the user based on their id, pass the `params` along so</span>
      <span class="token comment">// that we get a safe version of the user data</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Merge the message content to include the `user` object</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>message<span class="token punctuation">,</span>
        user
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// In a find method we need to process the entire page</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'find'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Map all data to include the `user` information</span>
      context<span class="token punctuation">.</span>result<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>addUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Otherwise just update the single result</span>
      context<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addUser</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></section></div></div> <blockquote><p><strong>Note:</strong> <code>Promise.all</code> makes sure that all asynchronous operations complete before returning all the data.</p></blockquote> <blockquote><p><strong>Pro tip:</strong> This is one way to associate data in Feathers. For more information about associations see <a href="/help/faq.html#how-do-i-do-associations">this FAQ</a>.</p></blockquote> <h2 id="hooks-vs-extending-services"><a href="#hooks-vs-extending-services" class="header-anchor">#</a> Hooks vs. extending services</h2> <p>In the <a href="/guides/basics/services.html">previous chapter</a> we extended our user service to add a user avatar. This could also be put in a hook instead but made a good example to illustrate how to extend an existing service. There are no explicit rules when to use a hook or when to extend a service but here are some guidelines.</p> <p>Use a hook when</p> <ul><li>The functionality can be used in more than one place (e.g. validation, permissions etc.)</li> <li>It is not a core responsibility of the service and the service can work without it (e.g. sending an email after a user has been created)</li></ul> <p>Extend a service when</p> <ul><li>The functionality is only needed in this one place</li> <li>The service could not function without it</li></ul> <p>Create your own (custom) service when</p> <ul><li>Multiple services are combined together (e.g. reports)</li> <li>The service does something other than talk to a database (e.g. another API, sensors etc.)</li></ul> <h2 id="what-s-next"><a href="#what-s-next" class="header-anchor">#</a> What's next?</h2> <p>In this chapter we learned how Feathers hooks can be used as middleware for service method calls to validate and manipulate incoming and outgoing data without having to change our service. We now have a fully working chat application. Before we <a href="/guides/basics/frontend.html">create a frontend for it</a> though, let's first look at how <a href="/guides/basics/authentication.html">authentication works with Feathers</a>.</p></div> <footer class="page-edit"><blockquote><p>
        Anything unclear or missing?
        <a href="/help" rel="noopener noreferrer">
          Get help
        </a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span> or <a href="https://github.com/feathersjs/docs/edit/crow/guides/basics/hooks.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></p> <small><span class="prefix">Last Updated: </span> <span class="time">4/15/2020, 9:30:23 AM</span></small></blockquote></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/guides/basics/services.html" class="prev">
          Services
        </a></span> <span class="next"><a href="/guides/basics/authentication.html">
          Authentication
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f4b1d533.js" defer></script><script src="/assets/js/3.7ef197bc.js" defer></script><script src="/assets/js/6.bfb1454e.js" defer></script>
  </body>
</html>
